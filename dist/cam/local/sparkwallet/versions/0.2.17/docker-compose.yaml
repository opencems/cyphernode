version: "3"

# <%= APP_UPSTREAM_HOST %>: Hostname for the upstream into cyphernodes reverse proxy to expose the app to the world
# <%= APP_ID %> use this to avoid conflicts in hostname in case you have multiple services in your app
# if you need those values inside your app, you can pass them in the environment
# container names will be ignored
# Prefix all container names you use with the <%= APP_ID %> to prevent unwanted namespace collision
# between apps. It's very likely if you use a database like redis or mongo that you will name this
# container 'mongo' or 'redis' like every other app developer, so there will be container name
# collisions. Consider using '<%= APP_ID %>_redis' or '<%= APP_ID %>_mongo' instead.
# container names will be checked and if they don't contain the unique part, the app won't be
# able to be installed

# NOTE
# ${ RUNTIME_VAR }  <-  evaluated at start
# <%= STATIC_VAR %> <-  evaluated at install

services:
  # This is the container which will be used as the reverse proxy upstream
  <%= APP_UPSTREAM_HOST %>:
    command: --no-tls
    image: cyphernode/sparkwallet:v0.2.17
    volumes:
      - "${TRUSTED__LIGHTNING_DATAPATH}:/etc/lightning"
      - "${APP_DATAPATH}/cookie:/data/spark/cookie"
    # labels are for traefik > 2.0
    # TODO: swarm mode (deploy:)
    labels:
      - traefik.http.middlewares.<%= APP_ID %>-addslash.redirectregex.regex=^(https{0,1}://[^/]+?)/<%= APP_MOUNTPOINT %>$$
      - traefik.http.middlewares.<%= APP_ID %>-addslash.redirectregex.replacement=$$1/<%= APP_MOUNTPOINT %>/
      # this is the auth header for the standard user defined in cookie, so sparkwallet does not ask for a login
      - traefik.http.middlewares.<%= APP_ID %>-headers.headers.customrequestheaders.X-Access=FoeDdQw5yl7pPfqdlGy3OEk/txGqyJjSbVtffhzs7kc=
      - traefik.http.services.<%= APP_ID %>.loadbalancer.server.port=9737
    networks:
      - cyphernodeappsnet
networks:
  cyphernodeappsnet:
    external: true
